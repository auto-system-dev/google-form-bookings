<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>選擇房型</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css" />
<script src="api.js"></script>
</head>

<body>
<header class="header">選擇房型</header>

<div id="roomList" class="container">
  <div class="card">
    <div class="card-title">載入中...</div>
  </div>
</div>

<script>
// 從上一頁帶入條件（如果你有存）
const checkin = localStorage.getItem("checkin") || "2025-01-01";
const nights  = Number(localStorage.getItem("nights") || 1);

// 載入房型
async function loadRooms() {
  const listEl = document.getElementById("roomList");
  listEl.innerHTML = `<div class="card"><div class="card-title">載入中...</div></div>`;

  try {
    const roomRes  = await apiRooms();
    if (!roomRes.success) throw roomRes.message || "rooms error";

    const rooms = roomRes.rooms || [];

    const availRes = await apiAvailability(checkin, nights);
    const remainMap = (availRes.remain) || {};

    if (!rooms.length) {
      listEl.innerHTML = `<div class="card"><div class="card-title">目前尚無房型</div></div>`;
      return;
    }

    listEl.innerHTML = "";

    rooms.forEach(r => {
      const remain = remainMap[r.room_id] ?? r.stock ?? 0;

      listEl.innerHTML += `
        <div class="room-card">
          <img class="card-img" src="${r.image || ''}" alt="${r.name}">
          <div class="card-body">
            <div class="room-name">${r.name}</div>
            <div class="room-price">NT$ ${r.price} / 晚</div>
            <div style="margin-bottom:8px;color:#5f6368;">剩餘 ${remain} 間</div>
            <button class="room-btn" ${remain<=0 ? "disabled" : ""} 
                    onclick="selectRoom('${r.room_id}', '${r.name}', ${r.price}, ${remain})">
              ${remain>0 ? "選擇此房型" : "已無空房"}
            </button>
          </div>
        </div>
      `;
    });

  } catch (err) {
    console.error(err);
    listEl.innerHTML = `
      <div class="card">
        <div class="card-title">資料載入失敗，請稍後再試</div>
      </div>
    `;
  }
}

function selectRoom(id, name, price, remain) {
  if (remain <= 0) return;
  localStorage.setItem("room_id", id);
  localStorage.setItem("room_name", name);
  localStorage.setItem("room_price", price);
  window.location.href = "booking-form.html";
}

loadRooms();
</script>
</body>
</html>
