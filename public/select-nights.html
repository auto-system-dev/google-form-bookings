<script>
const API = "https://script.google.com/macros/s/AKfycbx72JGTk3CuJe-z4AFdFm6N1OPJO0aIXq0fgjHY0DN1lCq7iHUtgEZu-YB7fiPP1t2J/exec";

let roomId = new URLSearchParams(location.search).get("roomId");
let date = new URLSearchParams(location.search).get("date");

let selectedNights = null;
let roomData = null;

// 從 API 取得房型資料
async function loadRoom() {
  const res = await fetch(`${API}?action=rooms`);
  const json = await res.json();
  const rooms = json.rooms;

  roomData = rooms.find(r => r.id === roomId);

  document.getElementById("roomInfo").innerHTML = `
    <div class="label">房型</div>
    <div class="value">${roomData.title}</div>
    <br>
    <div class="label">入住日期</div>
    <div class="value">${date}</div>
  `;

  renderNights();
}

// 產生晚數選擇
function renderNights() {
  const box = document.getElementById("nightsList");
  box.innerHTML = "";

  for (let n = Number(roomData.minNights); n <= Number(roomData.maxNights); n++) {
    const btn = document.createElement("div");
    btn.className = "night-btn";
    btn.innerText = `${n} 晚（$${(roomData.weekday * n).toLocaleString()}）`;

    btn.onclick = () => selectNight(n, btn);

    box.appendChild(btn);
  }
}

function selectNight(n, btnElement) {
  selectedNights = n;
  [...document.getElementsByClassName("night-btn")].forEach(b =>
    b.classList.remove("night-active")
  );
  btnElement.classList.add("night-active");

  document.getElementById("nextBtn").disabled = false;
}

document.getElementById("nextBtn").onclick = () => {
  const checkoutDate = getCheckoutDate(date, selectedNights);
  window.location.href =
    `form.html?roomId=${roomId}&date=${date}&nights=${selectedNights}&checkout=${checkoutDate}`;
};

function getCheckoutDate(start, nights) {
  const d = new Date(start);
  d.setDate(d.getDate() + nights);
  return d.toISOString().split("T")[0];
}

loadRoom();
</script>
